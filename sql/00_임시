WITH last_pm AS (
  WITH h AS (
    SELECT
      eqp_id,
      eqp_status,
      eqp_status_change_time AS t,
      LEAD(eqp_status, 1) OVER (PARTITION BY eqp_id ORDER BY eqp_status_change_time) AS s1,
      LEAD(eqp_status_change_time, 2) OVER (PARTITION BY eqp_id ORDER BY eqp_status_change_time) AS t2,
      LEAD(eqp_status, 2) OVER (PARTITION BY eqp_id ORDER BY eqp_status_change_time) AS s2
    FROM mos_kh_smi.smimes_mi_eqp_hist
    WHERE eqp_id = 'IMRB301-A'
      AND eqp_status_change_time BETWEEN
            concat(from_unixtime(unix_timestamp() - 365*24*60*60, 'yyyyMMdd'), ' 000000')
        AND concat(from_unixtime(unix_timestamp() - 1*24*60*60,  'yyyyMMdd'), ' 235959')
  )
  SELECT
    'IMRB301-A' AS station,
    cast(from_unixtime(unix_timestamp(t,  'yyyyMMdd HHmmss')) as timestamp)  AS pm_start_ts,
    cast(from_unixtime(unix_timestamp(t2, 'yyyyMMdd HHmmss')) as timestamp) AS pm_end_ts
  FROM h
  WHERE eqp_status = 'PM'
    AND s1 = 'LOCAL'
    AND s2 IN ('IDLE','RUN')
    AND t2 IS NOT NULL
  ORDER BY t2 DESC
  LIMIT 1
),

rs_evt AS (
  SELECT
    concat(prc_eqp_id, '-', chamber_ids) AS station,
    prc_tkin_time AS rs_time,
    container_id,
    npw_wafer_id,
    prc_slot_id,
    prc_ppid,
    count(distinct subitem_id) AS n_points
  FROM fab.m_fab_npw_met m
  CROSS JOIN last_pm p
  WHERE m.prc_eqp_id = 'IMRB301'
    AND m.chamber_ids = 'A'
    AND m.item_id = 'RS1'
    AND m.subitem_id RLIKE '^S[0-9]+$'
    AND m.prc_tkin_time BETWEEN p.pm_start_ts AND p.pm_end_ts
  GROUP BY
    concat(prc_eqp_id, '-', chamber_ids),
    prc_tkin_time, container_id, npw_wafer_id, prc_slot_id, prc_ppid
  HAVING count(distinct subitem_id) IN (49,81,151)
),

dcop_wide AS (
  SELECT
    concat(prc_eqp_id, '-', chamber_ids) AS station,
    container_id,
    npw_wafer_id,
    prc_slot_id,
    max(case when item_id like '%_OFFSET1' then value end) as t1,
    max(case when item_id like '%_OFFSET2' then value end) as t2,
    max(case when item_id like '%_OFFSET3' then value end) as t3,
    max(case when item_id like '%_OFFSET4' then value end) as t4,
    max(case when item_id like '%_OFFSET5' then value end) as t5,
    max(case when item_id like '%_OFFSET6' then value end) as t6,
    max(case when item_id like '%_OFFSET7' then value end) as t7
  FROM fab.m_fab_npw_dcop d
  WHERE d.prc_eqp_id = 'IMRB301'
    AND d.chamber_ids = 'A'
    AND d.item_id RLIKE '^[A-Z]_OFFSET[1-7]$'
  GROUP BY
    concat(prc_eqp_id, '-', chamber_ids),
    container_id, npw_wafer_id, prc_slot_id
)

SELECT
  COUNT(*) AS rs_evt_cnt,
  SUM(CASE WHEN w.t1 IS NOT NULL THEN 1 ELSE 0 END) AS joined_cnt
FROM rs_evt r
LEFT JOIN dcop_wide w
  ON r.station = w.station
 AND r.container_id = w.container_id
 AND r.npw_wafer_id = w.npw_wafer_id
 AND r.prc_slot_id  = w.prc_slot_id;