WITH params AS (
  SELECT
    now() - interval 365 days AS start_ts,
    now() AS end_ts
),

-- 우리 범위의 VANTAGE station(챔버 포함) + line(area)
team_station AS (
  SELECT DISTINCT
    m.STATION AS station,
    m.area    AS line
  FROM fab.m_tpss_station_master m
  WHERE SUBSTR(m.room, -1) = '5'
    AND m.STATION_NAME IN ('VANTAGE-PLUS','VANTAGE_PLUS','VANTAGE')
    AND m.STATION LIKE '%-%'
),

/* PM 세션 정의: PM -> LOCAL -> (IDLE or RUN)
   pm_start_time = PM 입력시간
   pm_end_time   = IDLE/RUN 입력시간
   duration      = 4~10시간만
*/
h AS (
  SELECT
    eqp_id,
    eqp_status,
    eqp_status_change_time AS t,

    LEAD(eqp_status, 1) OVER (PARTITION BY eqp_id ORDER BY eqp_status_change_time) AS s1,
    LEAD(eqp_status_change_time, 2) OVER (PARTITION BY eqp_id ORDER BY eqp_status_change_time) AS t2,
    LEAD(eqp_status, 2) OVER (PARTITION BY eqp_id ORDER BY eqp_status_change_time) AS s2
  FROM mos_kh_smi.smimes_mi_eqp_hist
  WHERE eqp_id IN (SELECT station FROM team_station)
    AND eqp_status_change_time BETWEEN
          concat(from_unixtime(unix_timestamp((SELECT start_ts FROM params)), 'yyyyMMdd'), ' 000000')
      AND concat(from_unixtime(unix_timestamp((SELECT end_ts   FROM params)), 'yyyyMMdd'), ' 235959')
),

pm_session AS (
  SELECT
    eqp_id AS station,
    cast(from_unixtime(unix_timestamp(t,  'yyyyMMdd HHmmss')) as timestamp) AS pm_start_ts,
    cast(from_unixtime(unix_timestamp(t2, 'yyyyMMdd HHmmss')) as timestamp) AS pm_end_ts
  FROM h
  WHERE eqp_status = 'PM'
    AND s1 = 'LOCAL'
    AND s2 IN ('IDLE','RUN')
    AND t2 IS NOT NULL
    AND (unix_timestamp(t2, 'yyyyMMdd HHmmss') - unix_timestamp(t, 'yyyyMMdd HHmmss')) BETWEEN 4*3600 AND 10*3600
),

-- RS 이벤트(완성된 포인트만): 49/81/121/151
rs_evt AS (
  SELECT
    concat(m.prc_eqp_id, '-', m.chamber_ids) AS station,
    m.prc_tkin_time AS rs_time,
    m.container_id,
    m.npw_wafer_id,
    m.prc_slot_id,
    m.prc_ppid,
    count(distinct m.subitem_id) AS n_points
  FROM fab.m_fab_npw_met m
  WHERE m.item_id = 'RS1'
    AND m.subitem_id RLIKE '^S[0-9]+$'
    AND m.prc_tkin_time BETWEEN (SELECT start_ts FROM params) AND (SELECT end_ts FROM params)
  GROUP BY
    concat(m.prc_eqp_id, '-', m.chamber_ids),
    m.prc_tkin_time,
    m.container_id,
    m.npw_wafer_id,
    m.prc_slot_id,
    m.prc_ppid
  HAVING count(distinct m.subitem_id) IN (49,81,121,151)
),

-- PM 세션 구간 안에 들어온 RS만 남김 + test_seq 부여
rs_in_pm AS (
  SELECT
    p.station,
    p.pm_start_ts,
    p.pm_end_ts,
    r.rs_time,
    r.container_id,
    r.npw_wafer_id,
    r.prc_slot_id,
    r.prc_ppid,
    r.n_points,
    ROW_NUMBER() OVER (
      PARTITION BY p.station, p.pm_start_ts, p.pm_end_ts
      ORDER BY r.rs_time
    ) AS test_seq
  FROM pm_session p
  JOIN rs_evt r
    ON r.station = p.station
   AND r.rs_time BETWEEN p.pm_start_ts AND p.pm_end_ts
),

-- DCOP 7개 OFFSET 피벗
dcop_wide AS (
  SELECT
    concat(d.prc_eqp_id, '-', d.chamber_ids) AS station,
    d.container_id,
    d.npw_wafer_id,
    d.prc_slot_id,

    max(case when d.item_id IN (concat(d.chamber_ids,'_OFFSET1'), concat(d.chamber_ids,'_T1_OFFSET')) then d.value end) as t1,
    max(case when d.item_id IN (concat(d.chamber_ids,'_OFFSET2'), concat(d.chamber_ids,'_T2_OFFSET')) then d.value end) as t2,
    max(case when d.item_id IN (concat(d.chamber_ids,'_OFFSET3'), concat(d.chamber_ids,'_T3_OFFSET')) then d.value end) as t3,
    max(case when d.item_id IN (concat(d.chamber_ids,'_OFFSET4'), concat(d.chamber_ids,'_T4_OFFSET')) then d.value end) as t4,
    max(case when d.item_id IN (concat(d.chamber_ids,'_OFFSET5'), concat(d.chamber_ids,'_T5_OFFSET')) then d.value end) as t5,
    max(case when d.item_id IN (concat(d.chamber_ids,'_OFFSET6'), concat(d.chamber_ids,'_T6_OFFSET')) then d.value end) as t6,
    max(case when d.item_id IN (concat(d.chamber_ids,'_OFFSET7'), concat(d.chamber_ids,'_T7_OFFSET')) then d.value end) as t7

  FROM fab.m_fab_npw_dcop d
  WHERE d.prc_tkin_time BETWEEN (SELECT start_ts FROM params) AND (SELECT end_ts FROM params)
    AND (
         d.item_id RLIKE '^[A-Z]_OFFSET[1-7]$'
      OR d.item_id RLIKE '^[A-Z]_T[1-7]_OFFSET$'
    )
  GROUP BY
    concat(d.prc_eqp_id, '-', d.chamber_ids),
    d.container_id,
    d.npw_wafer_id,
    d.prc_slot_id
),

events AS (
  SELECT
    r.station,
    s.line,
    r.pm_start_ts,
    r.pm_end_ts,
    r.test_seq,

    r.rs_time,
    r.container_id,
    r.npw_wafer_id,
    r.prc_slot_id,
    r.prc_ppid,
    r.n_points,

    w.t1, w.t2, w.t3, w.t4, w.t5, w.t6, w.t7
  FROM rs_in_pm r
  JOIN team_station s
    ON r.station = s.station
  JOIN dcop_wide w
    ON r.station      = w.station
   AND r.container_id = w.container_id
   AND r.npw_wafer_id = w.npw_wafer_id
   AND r.prc_slot_id  = w.prc_slot_id
)

SELECT *
FROM events
WHERE t1 IS NOT NULL AND t2 IS NOT NULL AND t3 IS NOT NULL
  AND t4 IS NOT NULL AND t5 IS NOT NULL AND t6 IS NOT NULL AND t7 IS NOT NULL
ORDER BY rs_time DESC
LIMIT 200;