RS_LONG_SQL = r"""
WITH params AS (
  SELECT
    now() - interval 365 days AS start_ts,
    now() AS end_ts
),
team_station AS (
  SELECT DISTINCT
    m.STATION AS station,
    m.area    AS line
  FROM fab.m_tpss_station_master m
  WHERE SUBSTR(m.room, -1) = '5'
    AND m.STATION_NAME IN ('VANTAGE-PLUS','VANTAGE_PLUS','VANTAGE')
    AND m.STATION LIKE '%-%'
),
h AS (
  SELECT
    eqp_id,
    eqp_status,
    eqp_status_change_time AS t,
    LEAD(eqp_status, 1) OVER (PARTITION BY eqp_id ORDER BY eqp_status_change_time) AS s1,
    LEAD(eqp_status_change_time, 2) OVER (PARTITION BY eqp_id ORDER BY eqp_status_change_time) AS t2,
    LEAD(eqp_status, 2) OVER (PARTITION BY eqp_id ORDER BY eqp_status_change_time) AS s2
  FROM mos_kh_smi.smimes_mi_eqp_hist
  WHERE eqp_id IN (SELECT station FROM team_station)
    AND eqp_status_change_time BETWEEN
          concat(from_unixtime(unix_timestamp((SELECT start_ts FROM params)), 'yyyyMMdd'), ' 000000')
      AND concat(from_unixtime(unix_timestamp((SELECT end_ts   FROM params)), 'yyyyMMdd'), ' 235959')
),
pm_session AS (
  SELECT
    eqp_id AS station,
    cast(from_unixtime(unix_timestamp(t,  'yyyyMMdd HHmmss')) as timestamp) AS pm_start_ts,
    cast(from_unixtime(unix_timestamp(t2, 'yyyyMMdd HHmmss')) as timestamp) AS pm_end_ts
  FROM h
  WHERE eqp_status = 'PM'
    AND s1 = 'LOCAL'
    AND s2 IN ('IDLE','RUN')
    AND t2 IS NOT NULL
    AND (unix_timestamp(t2, 'yyyyMMdd HHmmss') - unix_timestamp(t, 'yyyyMMdd HHmmss')) BETWEEN 4*3600 AND 10*3600
),
rs_evt AS (
  SELECT
    concat(m.prc_eqp_id, '-', m.chamber_ids) AS station,
    m.prc_tkin_time AS rs_time,
    m.container_id,
    m.npw_wafer_id,
    m.prc_slot_id,
    m.prc_ppid,
    count(distinct m.subitem_id) AS n_points
  FROM fab.m_fab_npw_met m
  WHERE m.item_id = 'RS1'
    AND m.subitem_id RLIKE '^S[0-9]+$'
    AND m.prc_tkin_time BETWEEN (SELECT start_ts FROM params) AND (SELECT end_ts FROM params)
  GROUP BY
    concat(m.prc_eqp_id, '-', m.chamber_ids),
    m.prc_tkin_time,
    m.container_id,
    m.npw_wafer_id,
    m.prc_slot_id,
    m.prc_ppid
  HAVING count(distinct m.subitem_id) IN (49,81,121,151)
),
rs_in_pm AS (
  SELECT
    p.station,
    p.pm_start_ts,
    p.pm_end_ts,
    r.rs_time,
    r.container_id,
    r.npw_wafer_id,
    r.prc_slot_id,
    r.prc_ppid,
    r.n_points,
    DENSE_RANK() OVER (
      PARTITION BY p.station, p.pm_start_ts, p.pm_end_ts, r.prc_ppid
      ORDER BY r.rs_time
    ) AS test_seq
  FROM pm_session p
  JOIN rs_evt r
    ON r.station = p.station
   AND r.rs_time BETWEEN p.pm_start_ts AND p.pm_end_ts
),
dcop_wide AS (
  SELECT
    concat(d.prc_eqp_id, '-', d.chamber_ids) AS station,
    d.container_id,
    d.npw_wafer_id,
    d.prc_slot_id,
    max(case when d.item_id IN (concat(d.chamber_ids,'_OFFSET1'), concat(d.chamber_ids,'_T1_OFFSET')) then d.value end) as t1,
    max(case when d.item_id IN (concat(d.chamber_ids,'_OFFSET2'), concat(d.chamber_ids,'_T2_OFFSET')) then d.value end) as t2,
    max(case when d.item_id IN (concat(d.chamber_ids,'_OFFSET3'), concat(d.chamber_ids,'_T3_OFFSET')) then d.value end) as t3,
    max(case when d.item_id IN (concat(d.chamber_ids,'_OFFSET4'), concat(d.chamber_ids,'_T4_OFFSET')) then d.value end) as t4,
    max(case when d.item_id IN (concat(d.chamber_ids,'_OFFSET5'), concat(d.chamber_ids,'_T5_OFFSET')) then d.value end) as t5,
    max(case when d.item_id IN (concat(d.chamber_ids,'_OFFSET6'), concat(d.chamber_ids,'_T6_OFFSET')) then d.value end) as t6,
    max(case when d.item_id IN (concat(d.chamber_ids,'_OFFSET7'), concat(d.chamber_ids,'_T7_OFFSET')) then d.value end) as t7
  FROM fab.m_fab_npw_dcop d
  WHERE d.prc_tkin_time BETWEEN (SELECT start_ts FROM params) AND (SELECT end_ts FROM params)
    AND (
         d.item_id RLIKE '^[A-Z]_OFFSET[1-7]$'
      OR d.item_id RLIKE '^[A-Z]_T[1-7]_OFFSET$'
    )
  GROUP BY
    concat(d.prc_eqp_id, '-', d.chamber_ids),
    d.container_id,
    d.npw_wafer_id,
    d.prc_slot_id
),
events_key AS (
  SELECT
    r.station,
    r.pm_start_ts,
    r.pm_end_ts,
    concat(r.station, '|', cast(r.pm_start_ts as string)) AS pm_session_id,
    r.prc_ppid,
    r.test_seq,
    r.rs_time,
    r.container_id,
    r.npw_wafer_id,
    r.prc_slot_id
  FROM rs_in_pm r
  JOIN dcop_wide w
    ON r.station      = w.station
   AND r.container_id = w.container_id
   AND r.npw_wafer_id = w.npw_wafer_id
   AND r.prc_slot_id  = w.prc_slot_id
  WHERE w.t1 IS NOT NULL AND w.t2 IS NOT NULL AND w.t3 IS NOT NULL
    AND w.t4 IS NOT NULL AND w.t5 IS NOT NULL AND w.t6 IS NOT NULL AND w.t7 IS NOT NULL
)
SELECT
  e.station,
  e.pm_start_ts,
  e.pm_end_ts,
  e.pm_session_id,
  e.prc_ppid,
  e.test_seq,
  e.rs_time,
  e.container_id,
  e.npw_wafer_id,
  e.prc_slot_id,
  m.subitem_id,
  m.value
FROM fab.m_fab_npw_met m
JOIN events_key e
  ON concat(m.prc_eqp_id, '-', m.chamber_ids) = e.station
 AND m.prc_tkin_time = e.rs_time
 AND m.container_id  = e.container_id
 AND m.npw_wafer_id  = e.npw_wafer_id
 AND m.prc_slot_id   = e.prc_slot_id
WHERE m.item_id = 'RS1'
  AND m.subitem_id RLIKE '^S[0-9]+$'
"""

rs_long_df = getData(RS_LONG_SQL + "\nLIMIT 5000")
print("rs_long sample rows:", len(rs_long_df))
print(rs_long_df.head(5))

rs_long_df = add_dt_partition(rs_long_df, ts_col="pm_start_ts", dt_col="dt")
upload_parquet_by_dt(rs_long_df, dt_col="dt", key_prefix="rs_long_sample")