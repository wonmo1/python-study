WITH params AS (
  SELECT
    now() - interval 365 days AS start_ts,
    now() AS end_ts
),

-- TEAM + VANTAGE + ROOM5 + CH Ìè¨Ìï® station
team_station AS (
  SELECT DISTINCT
    STATION AS station
  FROM fab.m_tpss_station_master
  WHERE SUBSTR(room, -1) = '5'
    AND STATION_NAME IN ('VANTAGE-PLUS','VANTAGE_PLUS','VANTAGE')
    AND STATION LIKE '%-%'
),

-- RS Ïù¥Î≤§Ìä∏ ÌõÑÎ≥¥ (49/81/121/151 Ìè¨Ïù∏Ìä∏ ÏôÑÏÑ± Ïù¥Î≤§Ìä∏Îßå)
rs_evt AS (
  SELECT
    concat(m.prc_eqp_id, '-', m.chamber_ids) AS station,
    m.prc_tkin_time AS rs_time,
    m.container_id,
    m.npw_wafer_id,
    m.prc_slot_id,
    m.prc_ppid,
    count(distinct m.subitem_id) AS n_points
  FROM fab.m_fab_npw_met m
  WHERE m.item_id = 'RS1'
    AND m.subitem_id RLIKE '^S[0-9]+$'
    AND m.prc_tkin_time BETWEEN (SELECT start_ts FROM params) AND (SELECT end_ts FROM params)
  GROUP BY
    concat(m.prc_eqp_id, '-', m.chamber_ids),
    m.prc_tkin_time,
    m.container_id,
    m.npw_wafer_id,
    m.prc_slot_id,
    m.prc_ppid
  HAVING count(distinct m.subitem_id) IN (49,81,121,151)
),

-- DCOP ÌÇ§ (OFFSET Ï°¥Ïû¨ÌïòÎäî ÌÇ§Îßå)
dcop_key AS (
  SELECT DISTINCT
    concat(d.prc_eqp_id, '-', d.chamber_ids) AS station,
    d.container_id,
    d.npw_wafer_id,
    d.prc_slot_id
  FROM fab.m_fab_npw_dcop d
  WHERE d.prc_tkin_time BETWEEN (SELECT start_ts FROM params) AND (SELECT end_ts FROM params)
    AND d.item_id LIKE '%OFFSET%'
),

-- DCOP Îß§Ïπ≠Îêú RS Ïù¥Î≤§Ìä∏Îßå ÎÇ®ÍπÄ (ÏÑ†ÌÉù A)
rs_evt_matched AS (
  SELECT r.*
  FROM rs_evt r
  JOIN dcop_key k
    ON r.station      = k.station
   AND r.container_id = k.container_id
   AND r.npw_wafer_id = k.npw_wafer_id
   AND r.prc_slot_id  = k.prc_slot_id
),

-- DCOP 7Í∞ú OFFSET ÌîºÎ≤ó
dcop_wide AS (
  SELECT
    concat(d.prc_eqp_id, '-', d.chamber_ids) AS station,
    d.container_id,
    d.npw_wafer_id,
    d.prc_slot_id,

    max(case when d.item_id IN (concat(d.chamber_ids,'_OFFSET1'), concat(d.chamber_ids,'_T1_OFFSET')) then d.value end) as t1,
    max(case when d.item_id IN (concat(d.chamber_ids,'_OFFSET2'), concat(d.chamber_ids,'_T2_OFFSET')) then d.value end) as t2,
    max(case when d.item_id IN (concat(d.chamber_ids,'_OFFSET3'), concat(d.chamber_ids,'_T3_OFFSET')) then d.value end) as t3,
    max(case when d.item_id IN (concat(d.chamber_ids,'_OFFSET4'), concat(d.chamber_ids,'_T4_OFFSET')) then d.value end) as t4,
    max(case when d.item_id IN (concat(d.chamber_ids,'_OFFSET5'), concat(d.chamber_ids,'_T5_OFFSET')) then d.value end) as t5,
    max(case when d.item_id IN (concat(d.chamber_ids,'_OFFSET6'), concat(d.chamber_ids,'_T6_OFFSET')) then d.value end) as t6,
    max(case when d.item_id IN (concat(d.chamber_ids,'_OFFSET7'), concat(d.chamber_ids,'_T7_OFFSET')) then d.value end) as t7

  FROM fab.m_fab_npw_dcop d
  WHERE d.prc_tkin_time BETWEEN (SELECT start_ts FROM params) AND (SELECT end_ts FROM params)
    AND (
         d.item_id RLIKE '^[A-Z]_OFFSET[1-7]$'
      OR d.item_id RLIKE '^[A-Z]_T[1-7]_OFFSET$'
    )
  GROUP BY
    concat(d.prc_eqp_id, '-', d.chamber_ids),
    d.container_id,
    d.npw_wafer_id,
    d.prc_slot_id
),

-- ÏµúÏ¢Ö Í≤∞Ìï©
final AS (
  SELECT
    r.station,
    r.rs_time,
    r.container_id,
    r.npw_wafer_id,
    r.prc_slot_id,
    r.prc_ppid,
    r.n_points,
    w.t1, w.t2, w.t3, w.t4, w.t5, w.t6, w.t7
  FROM rs_evt_matched r
  JOIN dcop_wide w
    ON r.station      = w.station
   AND r.container_id = w.container_id
   AND r.npw_wafer_id = w.npw_wafer_id
   AND r.prc_slot_id  = w.prc_slot_id
)

-- üî• NULL Ï†úÍ±∞ Ï†ÅÏö©
SELECT *
FROM final
WHERE t1 IS NOT NULL
  AND t2 IS NOT NULL
  AND t3 IS NOT NULL
  AND t4 IS NOT NULL
  AND t5 IS NOT NULL
  AND t6 IS NOT NULL
  AND t7 IS NOT NULL
ORDER BY rs_time DESC
LIMIT 200;