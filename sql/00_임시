WITH params AS (
  SELECT now() - interval 365 days AS start_ts, now() AS end_ts
),
team_station AS (
  SELECT DISTINCT STATION AS station
  FROM fab.m_tpss_station_master
  WHERE SUBSTR(room, -1) = '5'
    AND STATION_NAME IN ('VANTAGE-PLUS','VANTAGE_PLUS','VANTAGE')
    AND STATION LIKE '%-%'
),
h AS (
  SELECT
    eqp_id, line_id, origin_line_id, eqp_status, eqp_status_change_time AS t,
    LEAD(eqp_status, 1) OVER (PARTITION BY eqp_id ORDER BY eqp_status_change_time) AS s1,
    LEAD(eqp_status_change_time, 2) OVER (PARTITION BY eqp_id ORDER BY eqp_status_change_time) AS t2,
    LEAD(eqp_status, 2) OVER (PARTITION BY eqp_id ORDER BY eqp_status_change_time) AS s2
  FROM mos_kh_smi.smimes_mi_eqp_hist
  WHERE eqp_id IN (SELECT station FROM team_station)
    AND eqp_status_change_time BETWEEN
          concat(from_unixtime(unix_timestamp((SELECT start_ts FROM params)), 'yyyyMMdd'), ' 000000')
      AND concat(from_unixtime(unix_timestamp((SELECT end_ts   FROM params)), 'yyyyMMdd'), ' 235959')
),
pm_filtered AS (
  SELECT
    eqp_id AS station,
    line_id, origin_line_id,
    cast(from_unixtime(unix_timestamp(t,  'yyyyMMdd HHmmss')) as timestamp) AS pm_start_ts,
    cast(from_unixtime(unix_timestamp(t2, 'yyyyMMdd HHmmss')) as timestamp) AS pm_end_ts
  FROM h
  WHERE eqp_status = 'PM'
    AND s1 = 'LOCAL'
    AND s2 IN ('IDLE','RUN')
    AND t2 IS NOT NULL
    AND (unix_timestamp(t2, 'yyyyMMdd HHmmss') - unix_timestamp(t, 'yyyyMMdd HHmmss')) BETWEEN 4*3600 AND 10*3600
),
rs_evt AS (
  SELECT
    concat(m.prc_eqp_id, '-', m.chamber_ids) AS station,
    m.prc_tkin_time AS rs_time,
    m.container_id,
    m.npw_wafer_id,
    m.prc_slot_id,
    m.prc_ppid,
    count(distinct m.subitem_id) AS n_points
  FROM fab.m_fab_npw_met m
  WHERE m.item_id = 'RS1'
    AND m.subitem_id RLIKE '^S[0-9]+$'
    AND m.prc_tkin_time BETWEEN (SELECT start_ts FROM params) AND (SELECT end_ts FROM params)
  GROUP BY
    concat(m.prc_eqp_id, '-', m.chamber_ids),
    m.prc_tkin_time, m.container_id, m.npw_wafer_id, m.prc_slot_id, m.prc_ppid
  HAVING count(distinct m.subitem_id) IN (49,81,151)
),
rs_event AS (
  SELECT
    p.station, p.line_id, p.origin_line_id, p.pm_start_ts, p.pm_end_ts,
    r.rs_time, r.container_id, r.npw_wafer_id, r.prc_slot_id, r.prc_ppid, r.n_points
  FROM pm_filtered p
  JOIN rs_evt r
    ON r.station = p.station
   AND r.rs_time BETWEEN p.pm_start_ts AND p.pm_end_ts
),
dcop_wide AS (
  SELECT
    concat(d.prc_eqp_id, '-', d.chamber_ids) AS station,
    d.container_id, d.npw_wafer_id, d.prc_slot_id,
    max(case when d.item_id IN (concat(d.chamber_ids,'_OFFSET1'), concat(d.chamber_ids,'_T1_OFFSET')) then d.value end) as t1
  FROM fab.m_fab_npw_dcop d
  WHERE d.prc_tkin_time BETWEEN (SELECT start_ts FROM params) AND (SELECT end_ts FROM params)
    AND (
         d.item_id RLIKE '^[A-Z]_OFFSET[1-7]$'
      OR d.item_id RLIKE '^[A-Z]_T[1-7]_OFFSET$'
    )
  GROUP BY concat(d.prc_eqp_id, '-', d.chamber_ids), d.container_id, d.npw_wafer_id, d.prc_slot_id
),
final AS (
  SELECT e.*, w.t1
  FROM rs_event e
  LEFT JOIN dcop_wide w
    ON e.station      = w.station
   AND e.container_id = w.container_id
   AND e.npw_wafer_id = w.npw_wafer_id
   AND e.prc_slot_id  = w.prc_slot_id
)
SELECT
  COUNT(*) AS total_rows,
  SUM(CASE WHEN t1 IS NULL THEN 1 ELSE 0 END) AS null_rows
FROM final;