WITH params AS (
  SELECT now() - interval 10 days AS start_ts, now() AS end_ts
),

-- 1) PM 세션 (PM-LOCAL-IDLE/RUN, 4~10h)
h AS (
  SELECT
    eqp_id,
    eqp_status,
    eqp_status_change_time AS t,
    LEAD(eqp_status, 1) OVER (PARTITION BY eqp_id ORDER BY eqp_status_change_time) AS s1,
    LEAD(eqp_status_change_time, 2) OVER (PARTITION BY eqp_id ORDER BY eqp_status_change_time) AS t2,
    LEAD(eqp_status, 2) OVER (PARTITION BY eqp_id ORDER BY eqp_status_change_time) AS s2
  FROM mos_kh_smi.smimes_mi_eqp_hist
  WHERE eqp_id IN (
    SELECT STATION
    FROM fab.m_tpss_station_master
    WHERE SUBSTR(room, -1) = '5'
      AND STATION_NAME IN ('VANTAGE-PLUS','VANTAGE_PLUS','VANTAGE')
      AND STATION LIKE '%-%'
  )
  AND eqp_status_change_time BETWEEN
        concat(from_unixtime(unix_timestamp((SELECT start_ts FROM params)), 'yyyyMMdd'), ' 000000')
    AND concat(from_unixtime(unix_timestamp((SELECT end_ts   FROM params)), 'yyyyMMdd'), ' 235959')
),

pm AS (
  SELECT
    eqp_id AS station,
    cast(from_unixtime(unix_timestamp(t,  'yyyyMMdd HHmmss')) as timestamp) AS pm_start_ts,
    cast(from_unixtime(unix_timestamp(t2, 'yyyyMMdd HHmmss')) as timestamp) AS pm_end_ts,
    unix_timestamp(t2, 'yyyyMMdd HHmmss') - unix_timestamp(t, 'yyyyMMdd HHmmss') AS dur_sec
  FROM h
  WHERE eqp_status = 'PM'
    AND s1 = 'LOCAL'
    AND s2 IN ('IDLE','RUN')
    AND t2 IS NOT NULL
),

pm_filtered AS (
  SELECT *
  FROM pm
  WHERE dur_sec BETWEEN 4*3600 AND 10*3600
),

-- 2) RS 이벤트(= PM 세션 안에서 RS1 수행 건) + ✅ 레시피 필터 추가
rs_evt AS (
  SELECT
    concat(met.prc_eqp_id, '-', met.chamber_ids) AS station,
    met.prc_tkin_time AS rs_time,
    met.container_id,
    met.npw_wafer_id,
    met.prc_slot_id,
    met.prc_ppid,
    count(distinct met.subitem_id) AS n_points
  FROM fab.m_fab_npw_met met
  WHERE met.item_id = 'RS1'
    AND met.subitem_id RLIKE '^S[0-9]+$'
    AND met.prc_ppid = 'TT_RA-108030'     -- ✅ RS 레시피(PPID) 필터
    AND met.prc_tkin_time BETWEEN (SELECT start_ts FROM params) AND (SELECT end_ts FROM params)
  GROUP BY
    concat(met.prc_eqp_id, '-', met.chamber_ids),
    met.prc_tkin_time,
    met.container_id,
    met.npw_wafer_id,
    met.prc_slot_id,
    met.prc_ppid
  HAVING count(distinct met.subitem_id) IN (49,81,151)
),

rs_in_pm AS (
  SELECT
    p.station,
    p.pm_start_ts,
    p.pm_end_ts,
    r.rs_time,
    r.container_id,
    r.npw_wafer_id,
    r.prc_slot_id,
    r.prc_ppid,
    r.n_points
  FROM pm_filtered p
  JOIN rs_evt r
    ON r.station = p.station
   AND r.rs_time BETWEEN p.pm_start_ts AND p.pm_end_ts
),

rs_event AS (
  SELECT
    station,
    pm_start_ts,
    pm_end_ts,
    rs_time,
    row_number() OVER (
      PARTITION BY station, pm_start_ts, pm_end_ts
      ORDER BY rs_time, container_id, npw_wafer_id, prc_slot_id
    ) AS test_seq,
    container_id,
    npw_wafer_id,
    prc_slot_id,
    prc_ppid,
    n_points
  FROM rs_in_pm
),

-- 3) DCOP 7행 -> t1~t7 피벗
dcop_wide AS (
  SELECT
    concat(prc_eqp_id, '-', chamber_ids) AS station,
    container_id,
    npw_wafer_id,
    prc_slot_id,

    max(case when item_id like '%_T1_OFFSET' then value end) as t1,
    max(case when item_id like '%_T2_OFFSET' then value end) as t2,
    max(case when item_id like '%_T3_OFFSET' then value end) as t3,
    max(case when item_id like '%_T4_OFFSET' then value end) as t4,
    max(case when item_id like '%_T5_OFFSET' then value end) as t5,
    max(case when item_id like '%_T6_OFFSET' then value end) as t6,
    max(case when item_id like '%_T7_OFFSET' then value end) as t7

  FROM fab.m_fab_npw_dcop
  WHERE prc_tkin_time BETWEEN (SELECT start_ts FROM params) AND (SELECT end_ts FROM params)
    AND item_id RLIKE '^[A-Z]_T[1-7]_OFFSET$'
  GROUP BY
    concat(prc_eqp_id, '-', chamber_ids),
    container_id,
    npw_wafer_id,
    prc_slot_id
)

-- 4) RS 이벤트 + DCOP 조인
SELECT
  e.station,
  e.pm_start_ts,
  e.pm_end_ts,
  e.test_seq,
  e.rs_time,
  e.container_id,
  e.npw_wafer_id,
  e.prc_slot_id,
  e.prc_ppid,
  e.n_points,
  w.t1, w.t2, w.t3, w.t4, w.t5, w.t6, w.t7
FROM rs_event e
LEFT JOIN dcop_wide w
  ON e.station      = w.station
 AND e.container_id = w.container_id
 AND e.npw_wafer_id = w.npw_wafer_id
 AND e.prc_slot_id  = w.prc_slot_id
ORDER BY e.rs_time DESC
LIMIT 200;